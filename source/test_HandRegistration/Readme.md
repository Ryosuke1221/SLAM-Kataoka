# HandRegistration
# 0. プログラム概要

- 目視で点群同士の正しい重なり合いを確認しながら、点群をキー入力によって少しずつ動かすことで、点群位置合わせを行う。<br>

- 位置合わせの結果は、センサの軌跡(X, Y, Z, Roll, Pitch, Yaw)の形で出力する。<br>

- 既存の軌跡を読み込んで、位置合わせの結果によって軌跡を修正することができる。


# 1 言葉の定義

- ターゲット点群：位置合わせにおいて動かない方の点群。

- ソース点群：ターゲット点群に対して位置合わせされる点群。

- センサ位置：点群データ取得時にセンサが居た座標。<br>
位置合わせによって、この座標を正しく求めることを目指す。<br>
基本的に、センサ位置の初期値が原点にある状態から位置合わせが開始する。


# 2 ディレクトリ構造
```
SLAM-kataoka\
  ├source\
     ├test_HandRegistration\
  ├build\
  ├data\
     ├data_test_HandRegistration\
```

# 3 点群データについて


## 3.1 点群データの形式

点群データは.pcd拡張子で、pcl::PointXYZIとpcl::PointXYZRGBに対応している。<br>
コードを書き換えれば他の形式にも対応できる。

## 3.2 点群データの場所

点群データは、
```
data\data_test_HandRegistration\
```
に配置する。<br>


## 3.3 点群データの生成

点群が.csv形式のデータである場合は、を用いて.pcd形式に変換してから用いる。


# 4 設定パラメータ

ソースコード中ではあるが、設定パラメータが存在する。<br>
もし必要であれば、外部から入力できるように修正する。

<br>

以下に設定パラメータの説明を示す。<br>

| パラメータ | 意味 |
| :-- | :-- |
|  resolution_translation | 点群を1ステップだけ並進移動させる際の移動距離。 |
|  resolution_rotation | 点群を1ステップだけ回転移動させる際の回転角。 |


# 5 キー操作

キーボード入力によって点群の位置合わせを行う。<br>

<br>

以下に設定パラメータの説明を示す。<br>

| キー | 効果 |
| :-- | :-- |
| 1 | +X向きに変位。 |
| 2 | +Y向きに変位。 |
| 3 | +Z向きに変位。 |
| 4 | +Roll向きに変位。 |
| 5 | +Pitch向きに変位。 |
| 6 | +Yaw向きに変位。 |
| -(マイナス) | 1~6キーの効果を逆転させる。再度押して解除。 |
| ENTER | 移動中の点群の座標を確定し、次のフレームの点群の移動を開始する。 |
| Left Alt | 点群を移動前の座標に戻す。 |
| Left SHIFT | 直前のフレームの点群との、最近傍点距離の中央値を求める。 |
| Left CTRL | ICPによって、直前のフレームとの点群位置合わせを行う。 |
| ESC | 位置合わせを現在のフレームで中断して、軌跡を保存する。<br>フレームの途中でESCしても、途中経過を保存できる。 |


# 6 位置合わせの描画

- 2つのウィンドウによって位置合わせの点群が描画されるため、こちらを見ながら点群が正しく重なっているかどうかを確認しながら、手動で位置合わせを行う。

- ウィンドウ"show 2 frame"では、移動中の点群と、その一つ前のフレームの点群を描画する。

- ウィンドウ"show XYZRGB"では、移動中の点群と、その前のフレームの点群を全て描画する。


# 7 出力形式
```
data\data_test_HandRegistration\
```
- .csv形式のファイルがこの↑ディレクトリに存在しない場合<br>
この↑ディレクトリ直下にtransformation.csvというファイルが作成され、軌跡データが出力される。

- .csv形式のファイルが既にこの↑ディレクトリに存在していた場合<br>
位置合わせ前のセンサ位置の初期値として扱われ、位置合わせ結果はこのファイルに上書きされる。<br>

<br>

以下に.csv形式の出力データの列ごとの説明を示す。<br>

| 列 | 意味 |
| :-- | :-- |
| 1 | フレームのインデックス(0開始)。 |
| 2 | X方向の変位。 |
| 3 | Y方向の変位。 |
| 4 | Z方向の変位。 |
| 5 | Roll方向の変位。 |
| 6 | Pitch方向の変位。 |
| 7 | Yaw方向の変位。 |


# 8 実行手順

- build/Project.slnをVisual Studioで開く。

- test_HandRegistrationをスタートアッププロジェクトに指定する。

- デバッグなしで実行。<br>
コマンドプロンプトつが立ち上がる。

- please input process number<br>
HandRegistrationに該当する番号を入力してエンターを押す。<br>
(本資料作成時では6。)<br>
ウィンドウが立ち上がる。<br>

- ENTERを押す。<br>
最初のフレームの点群を固定する。<br>
コマンドプロンプトのウィンドウをクリックした状態でないと反応しない可能性がある。

- 以降の位置合わせを行う。

- Do you save txt?  Yes:1 No:0<br>
位置合わせをESCで中断、もしくは全フレーム終了すると表示される。<br>
1で結果を保存する。<br>
0で結果を破棄する。

<!-- プログラム実行の様子のスクリーンショットを貼ってもいいかも。 -->